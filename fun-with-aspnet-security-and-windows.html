<!DOCTYPE html>
<html lang="en">
<head>
          <title>Adam's Entropy</title>
        <meta charset="utf-8" />



    <meta name="tags" content=".net" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="http://adamgetchell.org/">Adam's Entropy <strong>One particular random walk through life</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="http://adamgetchell.org/fun-with-aspnet-security-and-windows.html" rel="bookmark"
         title="Permalink to Fun with ASP.NET security and Windows 2003 SP1 breakage">Fun with <span class="caps">ASP</span>.<span class="caps">NET</span> security and Windows 2003 <span class="caps">SP1</span>&nbsp;breakage</a></h2>
 
  </header>
  <footer class="post-info">
    <abbr class="published" title="2007-09-22T23:40:00-07:00">
      Sat 22 September 2007
    </abbr>
    <address class="vcard author">
      By           <a class="url fn" href="http://adamgetchell.org/author/adam-getchell.html">Adam Getchell</a>
    </address>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Problem: you want secure database access, using a connection string like&nbsp;this:</p>
<div class="cf">

<span class="cb1">\<</span><span class="cb2">add</span><span
class="cb3"></span><span class="cb4">key</span><span
class="cb1">=&#8221;DatabaseConnection&#8221;</span><span class="cb3"></span><span
class="cb4">value</span><span class="cb1">=&#8221;server=<span class="caps">SERVER</span>;Persist
Security Info=False;database=<span class="caps">DATABASE</span>;Integrated
Security=<span class="caps">SSPI</span>;&#8221;/\></span>

</div>

<p>Solution: First, we&#8217;re running <span class="caps">IIS6</span>.0. So we can set up a separate
Application Pool, and setup credentials for that application pool to&nbsp;use.</p>
<p>We <span style="FONT-WEIGHT: bold;">don&#8217;t</span> want to use
Impersonation, because then our connection credentials will run as the
application user, which may be different for each request, which will
slow database access down because we won&#8217;t be able to use database
connection&nbsp;pooling.</p>
<p>We <span style="FONT-WEIGHT: bold;">don&#8217;t</span> want to use a domain
account, because exploiting that account gives a free ride (and
reconnaissance) to our entire&nbsp;network.</p>
<p>We <span style="FONT-WEIGHT: bold;">do</span> want to use a local
account, with minimal rights on the Windows 2003/<span class="caps">IIS6</span>.0 server. We can
then duplicate that account on the <span class="caps">SQL</span> server, assign it appropriate
rights to the databases we&#8217;re using (and specifically, the stored
procedures), and then use pass-through&nbsp;authentication.</p>
<p>I used the <span class="caps">ASPNET</span> account (which will cause problems later, but they&#8217;re
interesting ones), though the account really doesn&#8217;t matter (i.e. I did
<span style="FONT-WEIGHT: bold;">not</span> use this account on our
production server, but another one like it.) I think it&#8217;s better to live
dangerously on development boxes, to catch problems early. Of course,
that&#8217;s not all. In order for the account to be able to startup an
application pool, it has to be a member of the IIS_WPG group. I didn&#8217;t
find that anywhere in <span class="caps">MSDN</span> or the <span class="caps">KB</span> articles, but by&nbsp;experimentation.</p>
<p>So, pick an account, add it to the IIS_WPG group, create an application
pool running under that account, duplicate that account on your <span class="caps">SQL</span>
server, set permissions to the databases and stored procedures&nbsp;desired.</p>
<p>Voila,&nbsp;right?</p>
<p>Problem #2: You want to use the Enterprise Library Data Access
Application Block. So following the guidelines you write some code like&nbsp;this:</p>
<div class="cf">

Database authDB = DatabaseFactory.CreateDatabase(&#8220;Authentication&#8221;);

DBCommandWrapper dbCommandWrapper =
authDB.GetStoredProcCommandWrapper(&#8220;usp\_LookupUserbyLoginID&#8221;);

dbCommandWrapper.AddInParameter(&#8220;@kerbID&#8221;, System.Data.DbType.String,
requestUserID);

IDataReader reader = authDB.ExecuteReader(dbCommandWrapper);

<span class="cb1">bool</span> records = <span class="cb1">false</span>;

</div>

<p>But get an error like this: <font size="+0"></span></p>
<h2><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"></h2>
<h2><em>Security&nbsp;Exception</em></h2>
<p><font face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif "><strong>Description:</strong>
The application attempted to perform an operation not allowed by the
security policy. To grant this application the required permission
please contact your system administrator or change the application&#8217;s
trust level in the configuration&nbsp;file.  </p>
<p><strong>Exception Details:</strong> System.Security.SecurityException: Requested
registry access is not&nbsp;allowed.  </p>
<p><strong>Source&nbsp;Error:</strong>  </p>
<p>+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;+
|     Line 157:    DBCommandWrapper dbCommandWrapper = authDB.GetStoredPro |
| cCommandWrapper(&#8220;usp_LookupUserbyLoginID&#8221;);                              |
|                                                                          |
|     Line 158:    dbCommandWrapper.AddInParameter(&#8220;@kerbID&#8221;, System.Data. |
| DbType.String, requestUserID);                                           |
|                                                                          |
|     Line 159:    IDataReader reader = authDB.ExecuteReader(dbCommandWrap |
| per);                                                                    |
|                                                                          |
|     Line 160:    bool records = false;                                   |
|                                                                          |
|     Line 161:                                                            |
|                                                                          |
| </code>                                                                  |&nbsp;+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;+</p>
<p><strong><font face="Verdana">Source File:
</font></strong>&#92;Webdevel.caes.ucdavis.edu\wwwroot\$\EligibilityList\AuthenticationModule.cs<strong><font face="Verdana">
   Line: </font></strong>159  </p>
<p><strong><font face="Verdana">Stack Trace:</font></strong>  </p>
<p>+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;+
|     [SecurityException: Requested registry access is not allowed.]       |
|                                                                          |
|        Microsoft.Win32.RegistryKey.OpenSubKey(String name, Boolean writa |
| ble) +473                                                                |
|                                                                          |
|        System.Diagnostics.EventLog.CreateEventSource(String source, Stri |
| ng logName, String machineName, Boolean useMutex) +443                   |
|                                                                          |
|        System.Diagnostics.EventLog.WriteEntry(String message, EventLogEn |
| tryType type, Int32 eventID, Int16 category, Byte[] rawData) +347        |
|                                                                          |
|        System.Diagnostics.EventLog.WriteEntry(String message, EventLogEn |
| tryType type, Int32 eventID, Int16 category) +21                         |
|                                                                          |
|        System.Diagnostics.EventLog.WriteEntry(String message, EventLogEn |
| tryType type, Int32 eventID) +15                                         |
|                                                                          |
|        Microsoft.Practices.EnterpriseLibrary.Common.Instrumentation.Even |
| tLogger.Log(String message)                                              |
|                                                                          |
| </code>                                                                  |&nbsp;+&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;+</p>
<p></font></i><span style="FONT-FAMILY: Arial,Helvetica,Geneva,SunSans-Regular,sans-serif;"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><font size="+0"><!--StartFragment --></p>
<p></h2>
</span></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font></font><font size="2"><font face="Arial">If
you look at the Stack Trace, you can see the problem is with the
CreateEventSource() call. Even though you haven’t specified using the
Enterprise Library Logging Block, secretly it is still using
System.Diagnostics.EventLog as part of its setup.</font></font></p>
<p><font size="2"><font face="Arial">Here’s an article which describes the
problem:</font></font></p>
<p><font size="2"><font face="Arial"><a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;329291"><span class="caps">PRB</span>: “Requested Registry Access Is
Not Allowed” Error Message When <span class="caps">ASP</span>.<span class="caps">NET</span> Application Tries to Write New
EventSource in the
EventLog</a></font></font></p>
<p><font size="2"><font face="Arial">Unfortunately, the solutions don’t
work. Solution #1, manually entering a registry key, didn’t work for
me. Solution #2, writing some code which calls CreateEventSource() also
doesn’t <em>quite</em> work either.</font></font></p>
<p><font size="2"><font face="Arial">I say <em>quite</em> because the issue is
that CreateEventSource() needs to be called by a user with
Administrative Rights. So what I did was create a project using my
ErrorHandler class (from <a href="http://acgetchell.blogspot.com/2005/02/fun-with-microsofts-enterprise-library.html">Fun with Microsoft’s Enterprise
Library</a>),
setup the project to run in App Pool #1 which runs using the <span class="caps">ASPNET</span>
account, grant that account Admin rights, do iisreset &amp;&amp; gpupdate
/force, open the project’s default web form thereby causing an event to
be written which calls the ErrorHandler class which calls
CreateEventSource(), and then go back and revoke admin rights on
<span class="caps">ASPNET</span>.</font></font></p>
<p><font size="2"><font face="Arial">Unfortunately, this needs to be done
for every application which will call CreateEventSource() — unless you
want to leave <span class="caps">ASPNET</span> running as Administrator (<strong>very bad
idea!</strong>).</font></font></p>
<p><font size="2"><font face="Arial">Inelegant, but it works. I’ve notified
Microsoft <span class="caps">KB</span> site of my findings; perhaps they’ll revise the article, or
show something more elegant.</font></font></p>
<p>Update: <font face="Arial" size="2">This is also discussed in the
<a href="http://www.gotdotnet.com/workspaces/customization/uploadedhtmlpage.aspx?FileID=ded67339-a081-489a-8d63-817323f31104&amp;id=295a464a-6072-4e25-94e2-91be63527327">Enterprise Library
<span class="caps">FAQ</span></a>.
However, the solutions given there are 1) run the “Install Services”
script (why would you install Visual Studio on a server?) 2) use
installutil on the <span class="caps">EL</span> assemblies (perhaps that will work — I’ll have to
try it) or 3) remove all logging from the <span class="caps">EL</span> (which in my case I
want).</font></p>
<p><font size="2"><font face="Arial">Okay, we’ve got that problem taken
care of. We write our <span class="caps">EL</span> application and breathlessly open the default
page, only to find:</font></font></p>
<p><font face="Arial" size="2"><!--StartFragment --><font face="Times New Roman" size="3"> Server
Error in &#8216;/EligibilityList&#8217;&nbsp;Application.  </p>
<hr />
<p>File or assembly name ko20f8cc.dll, or one of its dependencies, was not
found.<br />
Description: An unhandled exception occurred during the execution of the
current web request. Please review the stack trace for more information
about the error and where it originated in the&nbsp;code.  </p>
<p>Exception Details: System.<span class="caps">IO</span>.FileNotFoundException: File or assembly
name ko20f8cc.dll, or one of its dependencies, was not&nbsp;found.  </p>
<p>Source&nbsp;Error:  </p>
<p>Line 119:      private bool Authorize(string requestUserID)<br />
Line 120:      {<br />
Line 121:         Database authDB =
DatabaseFactory.CreateDatabase(&#8220;Authentication&#8221;);<br />
Line 122://         IDataReader dataReader;<br />
Line 123:         DBCommandWrapper dbCommandWrapper =
authDB.GetStoredProcCommandWrapper(&#8220;usp_LookupUserbyLoginID&#8221;, new
SqlParameter(&#8220;@kerbID&#8221;, requestUserID)); </font><br />
</font></p>
<p><font face="Arial" size="2">This was discussed in the
<a href="http://www.gotdotnet.com/workspaces/messageboard/thread.aspx?id=295a464a-6072-4e25-94e2-91be63527327&amp;threadid=ee840b95-2fb0-49c9-b888-26abd8268b98">GotDotNet</a>
forums. The problem is this:</font></p>
<p><font face="Arial" size="2"><a href="http://support.microsoft.com/default.aspx?scid=317012">Process and request identity in
<span class="caps">ASP</span>.<span class="caps">NET</span></a></font></p>
<p><font face="Arial" size="2">Behind the scenes the <span class="caps">DAAB</span> calls
XmlSerializer, which want to write a temporary assembly to run. <span class="caps">ASPNET</span>
(or the account you’re running under) doesn’t have access to the default
temp directory, C:\Windows\temp, so the assembly can’t be written and
the <span class="caps">DAAB</span> halts. Nice.</font></p>
<p><font face="Arial" size="2">To fix this, give the account the
Application Pool runs under <strong>Full</strong> (that’s right, it needs to create
subdirectories) permissions to C:\Windows\temp.</font></p>
<p><font face="Arial" size="2">By the way, this use of XmlSerializer has
<a href="http://www.gotdotnet.com/workspaces/messageboard/thread.aspx?id=295a464a-6072-4e25-94e2-91be63527327&amp;threadid=528cc244-f686-458f-b837-c5e319995087">performance
implications</a>.</p>
<p></font></p>
<p><font size="2"><font face="Arial">Finally, Enterprise Library is
installed, our code references it correctly, temporary assemblies can be
written locally, life is good.</font></font></p>
<p><font size="2"><font face="Arial">Then we install Windows Server 2003
Service Pack 1.</font></font></p>
<p><font size="2"><font face="Arial">And instantly, our web pages return
the very lonely:</font></font></p>
<p><font size="2"></p>
<h1><font face="Arial">Service Unavailable</font></h1>
<p><font face="Arial">Looking at <span class="caps">IIS</span> Manager, you can see that the
Application Pool has been disabled. Looking in the System Log from Event
Viewer shows this:</font></p>
<p><font size="1"></p>
<p><font face="Arial">A failure was encountered while launching the process
serving application pool &#8216;AppPool #1&#8217;. The application pool has been
disabled.</font></p>
<p><font face="Arial">For more information, see Help and Support Center at
</font><a href="http://go.microsoft.com/fwlink/events.asp"><font face="Arial">http://go.microsoft.com/fwlink/events.asp</font></a><font face="Arial">.</font></p>
<p><font face="Arial" size="2">Of course that link leads to no further
information.</font></p>
<p><font face="Arial" size="2">To cut to the chase, the problem is that
Windows Server 2003 <span class="caps">SP1</span> has revoked rights/permissions on the <span class="caps">ASPNET</span>
account, that cannot be restored even by placing it in the
Administrators group. The way to fix the problem is:</font></p>
<p><font face="Arial" size="2">Go to the .<span class="caps">NET</span> Framework Folder (typically
c:\Windows\Microsoft.<span class="caps">NET</span>\Framework\v1.1.4322)</font></p>
<p><font face="Arial" size="2">aspnet_regiis -ua to uninstall the
framework</font></p>
<p><font face="Arial" size="2">aspnet_regiis -i to reinstall the
framework</font></p>
<p><font face="Arial" size="2">In <span class="caps">IIS</span> Manager:</font></p>
<p><font face="Arial" size="2">Enable <span class="caps">ASP</span>.<span class="caps">NET</span> pages</font></p>
<p><font face="Arial" size="2">In User manager (compmgmt.msc)</font></p>
<p><font face="Arial" size="2">Set the <span class="caps">ASPNET</span> account with the password on
the <span class="caps">SQL</span> server, and as a member of IIS_WPG</font></p>
<p><font face="Arial" size="2">In <span class="caps">IIS</span> Manager:</font></p>
<p><font face="Arial" size="2">Set the Application pool to run under the
account with the password entered from the previous step</font></p>
<p><font face="Arial" size="2">At the Run command:</font></p>
<p><font face="Arial" size="2">iisreset to reset <span class="caps">IIS</span></font></p>
<p><font face="Arial" size="2">gpupdate /force to ensure password
synchronization</font></p>
<p><strong><font face="Arial" size="4">Wasn’t that fun?</font></strong></p>
<p><font face="Arial" size="2">Thank goodness Whidbey and Enterprise
Library v2.0 aren’t coming out until September.</font></p>
<p></font></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></span></font></p>
</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>