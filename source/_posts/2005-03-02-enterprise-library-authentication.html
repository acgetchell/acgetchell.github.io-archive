---
layout: post
title: "Enterprise Library authentication"
date: 2005-03-02
comments: false
categories:
 - .net
---

<div class='post'>
<a href="http://weblogs.asp.net/drohrer/">Doug Rohrer</a>, one of <a href="http://www.avanade.com/">Avanade</a> guys who worked on the Enterprise Library, has posted a fantastic End to End Enterprise Library project which incorporates the EL into ASP.NET and Winforms applications.<br /><br />Using Collin Collier's wonderful <a href="http://www.jtleigh.com/people/colin/software/CopySourceAsHtml/">Copy Source As HTML</a> makes blogging the code much easier.<br /><br />Looking at Doug's work, we run into the common pattern of writing a base page class which all asp.net pages inherit. Then he overrides the OnInit function to kickstart authentication.<br /><br />I've been using an <a href="http://support.microsoft.com/default.aspx?scid=kb;%5BLN%5D;Q307996">ASP.NET Http Module</a> to trap OnAuthenticate, but this is an interesting approach. Here's Dougs BasePage class:<br /><br /><style type="text/css">.cf { font-family: Courier New; font-size: 10pt; color: black; background: white; border-top: windowtext 1pt solid; padding-top: 0pt; border-left: windowtext 1pt solid; padding-left: 0pt; border-right: windowtext 1pt solid; padding-right: 0pt; border-bottom: windowtext 1pt solid; padding-bottom: 0pt; }.cl { margin: 0px; }.cb1 { color: blue; }.cb2 { color: gray; }.cb3 { color: green; }</style><div class="cf"><p class="cl"><span class="cb1">using</span> System;</p><p class="cl"><span class="cb1">using</span> Microsoft.Practices.EnterpriseLibrary.Security;</p><p class="cl"><span class="cb1">using</span> SecCache = Microsoft.Practices.EnterpriseLibrary.Security.Cache;</p><p class="cl"><span class="cb1">using</span> Microsoft.Practices.EnterpriseLibrary.Configuration;</p><p class="cl"><span class="cb1">using</span> System.Web.Security;</p><p class="cl"><span class="cb1">using</span> System.Security.Principal;</p><p class="cl"><span class="cb1">using</span> EntLibCommonCSharp;</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;</p><p class="cl"><span class="cb1">namespace</span> EntLibWebCSharp</p><p class="cl">{</p><p class="cl">&nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Summary description for BasePage.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; <span class="cb1">public</span> <span class="cb1">class</span> BasePage: System.Web.UI.Page</p><p class="cl">&nbsp;&nbsp;&nbsp; {</p><p class="cl">&nbsp;</p><p class="cl"><span class="cb1">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #region</span> Private Variables</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">private</span> IAuthenticationProvider _authenProvider;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">private</span> IAuthorizationProvider _authorProvider;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">private</span> IRolesProvider _rolesProvider;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">private</span> ISecurityCacheProvider _secCacheProvider;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">private</span> IPrincipal _principal;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">private</span> EntLibCommonCSharp.AppConfigData _config;</p><p class="cl">&nbsp;</p><p class="cl"><span class="cb1">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #endregion</span></p><p class="cl">&nbsp;</p><p class="cl"><span class="cb1">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #region</span> Public Properties</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> An Enterprize Library Authentication Provider instance.&nbsp; </span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Used to determine if a user's credentials are valid.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> IAuthenticationProvider AuthenProvider {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">get</span> {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (<span class="cb1">null</span>==_authenProvider) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _authenProvider = AuthenticationFactory.GetAuthenticationProvider();</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">return</span> _authenProvider;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> An Enterprize Library Authorization Provider instance.&nbsp; </span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Used to determine if a user is permitted to perform a certain action.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> IAuthorizationProvider AuthorProvider {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">get</span> {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (<span class="cb1">null</span>==_authorProvider) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _authorProvider = AuthorizationFactory.GetAuthorizationProvider();</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">return</span> _authorProvider;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> An Enterprize Library Roles Provider instance.&nbsp; </span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Used to retrieve a principal object given an identity.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> IRolesProvider RolesProvider {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">get</span> {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (<span class="cb1">null</span>==_rolesProvider) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _rolesProvider = RolesFactory.GetRolesProvider();</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">return</span> _rolesProvider;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> An Enterprize Library Security Cache Provider instance.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Used to store and retrieve a principal object given a security token.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> ISecurityCacheProvider SecCacheProvider {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">get</span> {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (<span class="cb1">null</span>==_secCacheProvider) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _secCacheProvider = SecurityCacheFactory.GetSecurityCacheProvider();</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">return</span> _secCacheProvider;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> The current principal</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> IPrincipal Principal {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">get</span> {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">return</span> _principal;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Provides easy access to configuration data in the application config file.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> AppConfigData Config {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">get</span> {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (<span class="cb1">null</span>==_config) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _config = (AppConfigData)ConfigurationManager.GetConfiguration(AppConfigManager.SectionName);</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">return</span> _config;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Sets the principal for this page request.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;param name="principal"&gt;</span><span class="cb3">The principal to use for the rest of the request.</span><span class="cb2">&lt;/param&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> <span class="cb1">void</span> SetPrincipal(IPrincipal principal) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; _principal = principal;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;</p><p class="cl"><span class="cb1">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; #endregion</span></p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">public</span> BasePage()</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb3">// No constructor necessary</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Fires at the beginning of the page lifecycle.&nbsp; Overriden here to retrieve principal data from the </span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Enterprise Library Security Cache provider or, if unable, to redirect to he login page.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> The Login.aspx page will add the appropriate token via the ASP.NET forms authentication cookie</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> if the user successfully logs in.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;param name="e"&gt;&lt;/param&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">protected</span> <span class="cb1">override</span> <span class="cb1">void</span> OnInit(EventArgs e) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">base</span>.OnInit(e);</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb3">// Make sure to skip this step if you're already on the login page</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (ResolveUrl("~/Login.aspx")!=Request.Url.AbsolutePath) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">try</span> {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb3">// Load the principal from the FormsAuthentication ticket information.</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; FormsAuthenticationTicket ticket = FormsAuthentication.Decrypt((<span class="cb1">string</span>)Request.Cookies[FormsAuthentication.FormsCookieName].Value);</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; GuidToken token = <span class="cb1">new</span> GuidToken(<span class="cb1">new</span> System.Guid(ticket.UserData));</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; IPrincipal principal = SecCacheProvider.GetPrincipal(token);</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (<span class="cb1">null</span>==principal) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Response.Redirect("~/Login.aspx");</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } <span class="cb1">else</span> {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; SetPrincipal(principal);</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; } <span class="cb1">catch</span> (Exception) {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb3">// If we have any issues, redirect to Login</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; Response.Redirect(ResolveUrl("~/Login.aspx"));</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; }</p><p class="cl">}</p></div><br /><br />Cool stuff!</div>
