---
layout: post
title: "Fun with Microsoft's Enterprise Library"
date: 2005-02-11
comments: false
categories:
 - .net
---

<div class='post'>
Oh yeah, back to my day-job: I'm a programmer.<br /><br />So we've got a new application to update the current stone-tablet process in the University that determines if students actually graduate.<br /><br />Now, I like to write good code, and furthermore, if someone else writes it for me, that's even better. So if you are working on the .NET platform, you'd do well to look at the <a href="http://www.microsoft.com/downloads/details.aspx?FamilyId=0325B97A-9534-4349-8038-D56B38EC394C&displaylang=en">Enterprise Library</a>.<br /><br />Of course, this is several thousand lines of code to pore over, good stuff, but unfortunately we have these minor annoying things called deadlines which prevents us from taking the time to grok everything properly.<br /><br />Come to think of it, this happens in Physics, too -- I never have enough time to actually understand all the details of the problems I'm supposed to be solving, but my advisor assures me that this is the proper state of things in research, as opposed to writing text books, and three guesses as to which one gets you tenure.<br /><br />Back to the matter at hand -- the Enterprise Library. Looking around at some good <a href="http://blog.hishambaz.com/archive/2005/01/29/194.aspx">working examples</a> , hilarity and pandemonium ensues when you try to do something simple like write to the Event Log when your application barfs. (Did I mention this doesn't come up a lot because instrumenting software seems to be a ... novelty?) I'm pretty sure that developers should <span style="font-weight: bold;">not</span> be doing things like editing the Registry, installing Services, or setting accounts programs run under with full admin rights -- I was a system administrator in a previous job, and I <span style="font-weight: bold;">hated</span> letting programmers do those kind of things.<br /><br />So I won't inflict the same damage on our own, long-suffering sysadmin.<br /><br />Now, my 52-line class solution doesn't do all the bells and whistles the EL does, but it sure doesn't require all the nastiness above:<br /><br /><style type="text/css">.cf { font-family: Courier New; font-size: 10pt; color: black; background: white; border-top: windowtext 1pt solid; padding-top: 0pt; border-left: windowtext 1pt solid; padding-left: 0pt; border-right: windowtext 1pt solid; padding-right: 0pt; border-bottom: windowtext 1pt solid; padding-bottom: 0pt; }.cl { margin: 0px; }.cb1 { color: blue; }.cb2 { color: gray; }.cb3 { color: green; }</style><div class="cf"><p class="cl"><span class="cb1">using</span> System;</p><p class="cl"><span class="cb1">using</span> System.Diagnostics;</p><p class="cl">&nbsp;</p><p class="cl"><span class="cb1">namespace</span> CAESDO</p><p class="cl">{</p><p class="cl">&nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Methods to handle error reporting</span></p><p class="cl">&nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; <span class="cb1">public</span> <span class="cb1">class</span> ErrorHandler</p><p class="cl">&nbsp;&nbsp;&nbsp; {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">public</span> ErrorHandler()</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb3">// Register application as source for Application log</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (!EventLog.SourceExists("FacultyStudentSurveys"))</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; EventLog.CreateEventSource("FacultyStudentSurveys", "Application");</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> Writes an error message to the Application Event Log</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;/summary&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb2">///</span><span class="cb3"> </span><span class="cb2">&lt;param name="error"&gt;</span><span class="cb3">The thrown exception</span><span class="cb2">&lt;/param&gt;</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> <span class="cb1">void</span> WriteToEventLog(Exception error)</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">const</span> <span class="cb1">string</span> source = "Commencement";</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">const</span> <span class="cb1">string</span> logName = "Application";</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; EventLogEntryType enumType = EventLogEntryType.Error;</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; EventLog objectLog = <span class="cb1">new</span> EventLog(logName);</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; objectLog.Source = source;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; objectLog.WriteEntry(error.Message, enumType, 1 );</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">internal</span> <span class="cb1">void</span> WriteToEventLog(<span class="cb1">string</span> message, <span class="cb1">bool</span> success)</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">const</span> <span class="cb1">string</span> source = "Commencement";</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">const</span> <span class="cb1">string</span> logName = "Application";</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; EventLogEntryType enumType;</p><p class="cl">&nbsp;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">if</span> (success)</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; enumType = EventLogEntryType.Information;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span class="cb1">else</span></p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; enumType = EventLogEntryType.Error;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; EventLog objectLog = <span class="cb1">new</span> EventLog(logName);</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; objectLog.Source = source;</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; objectLog.WriteEntry(message, enumType);</p><p class="cl">&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }</p><p class="cl">&nbsp;&nbsp;&nbsp; }</p><p class="cl">}</p></div><br /><br />I'm sure I've missed something obvious. Anyone?<br /><br />I just got a reply from the Hisam Baz, author of the above weblog which says, "Why write 52 lines of code when you can write 1?".<br /><br />To which I reply, "I'd be happy to write 1 line of code -- if it works."<br /><br />Which brings us to the second problem:<br /><br /><span style="font-weight: bold;">Non-portable references to the Global Assembly Cache in ASP.NET</span><br /><br />Once you actually try to use the Enterprise Library, you'll often come across this bit of advice:<br /><br />"<span style="font-weight: bold; font-style: italic;">References<br /><br /></span><span style="font-style: italic;">Then from your application, add references to Microsoft.Practices.EnterpriseLibrary.Configuration.dll</span><br /><span style="font-style: italic;">and Microsoft.Practices.EnterpriseLibrary.Logging.dll from the C:\Program Files\Microsoft Enterprise Library\bin\ directory. You should consider signing the assemblies and then adding them to the GAC. You should also add a copy of the assemblies to C:\Program Files\Microsoft Visual Studio .NET 2003\Common7\IDE. Once you do that, you can select the assemblies directly from the "Add Reference" dialog. One you've added the reference, then add the appropriate using statement - using Microsoft.Practices.EnterpriseLibrary.Logging - to your code."</span><br /><br />There's only one problem -- it doesn't work.<br /><br />1. When Visual Studio 2003 .NET looks for references in the Global Assembly Cache, it never updates its view of the GAC in response to what you've added -- that's done by the <a href="http://support.microsoft.com/default.aspx?scid=kb;en-us;306149">registry</a> (bleah). Which is why you've got to add a copy where VS can find it.<br /><br />2. When writing ASP.NET applications, references should be against assemblies in the webserver GAC. And naturally, installer projects written in VS 2003 do not install the files in the GAC automatically, as they do for the web application itself. So now you have to manually add assemblies to the GAC and write registry entries for each assembly to be resolved by the .NET runtime.<br /><br />Wait, why are we <a href="http://www.sellsbrothers.com/news/showTopic.aspx?ixTopic=1199">using the GAC</a> again?<br /><br />Okay, looks like I'll have to wade through <a href="http://www.grimes.demon.co.uk/workshops/fusionWS.htm">Richard Grime's Fusion Workshop</a>. Except that it doesn't cover the case I'm interested in. Joy.<br /><br />Well, I sure hope that the 10 lines of code I'll end up emitting in this exercise will exceed the several thousand I could be writing if I just wrote everything myself.<br /><br />What's that again about the virtues of programmers? Laziness, impatience, and hubris. Oh, alright then.</div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Adam Getchell</div>
<div class='content'>
Well, this class is pretty old now, and Enterprise Library v3 is much better. I don't have any programs that use it any more, but it used to be invoked out of global.asax.cs.</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
Again, where are you running this code, this class?</div>
</div>
<div class='comment'>
<div class='author'>Anonymous</div>
<div class='content'>
where and when are you running that error class in your app?</div>
</div>
</div>
